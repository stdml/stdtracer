#pragma once
#include <stdtracer.hpp>

/*! This header file is for simple use case.

You can customize all the definitions below,
by just `#include<stdtracer.hpp>` and re-implement your own macros.
*/

#ifndef STD_TRACER_ENABLE_TRACE_STACK
#define STD_TRACER_ENABLE_TRACE_STACK 0
#endif

#if STD_TRACER_ENABLE_TRACE_STACK
using tracer_t = scope_t_<stack_tracer_ctx_t>;

extern stack_tracer_ctx_t default_stack_tracer_ctx;
// user should define the following
// stack_tracer_ctx_t default_stack_tracer_ctx("global");
// or link with -lstdtracer

#define TRACE_SCOPE(name) tracer_t _((name), default_stack_tracer_ctx)

#define TRACE_STMT(e)                                                          \
    {                                                                          \
        tracer_t _(#e, default_stack_tracer_ctx);                              \
        e;                                                                     \
    }

#define TRACE_EXPR(e)                                                          \
    [&]() {                                                                    \
        tracer_t _(#e, default_stack_tracer_ctx);                              \
        return (e);                                                            \
    }()

#else

extern simple_tracer_ctx_t default_simple_ctx;
extern log_tracer_ctx_t default_log_ctx;

// user should define the following
// simple_tracer_ctx_t default_simple_ctx("global");
// log_tracer_ctx_t default_log_ctx("global");
// or link with -lstdtracer

using default_tracer_t = multi_tracer_t;

#define TRACE_SCOPE(name)                                                      \
    default_tracer_t _((name), default_simple_ctx, default_log_ctx)

#define TRACE_STMT(e)                                                          \
    {                                                                          \
        default_tracer_t _(#e, default_simple_ctx, default_log_ctx);           \
        e;                                                                     \
    }

#define TRACE_EXPR(e)                                                          \
    [&]() {                                                                    \
        default_tracer_t _(#e, default_simple_ctx, default_log_ctx);           \
        return (e);                                                            \
    }()

#define SET_TRACE_LOG(name)                                                    \
    set_trace_log_t<log_tracer_ctx_t> ___((name), default_log_ctx)

template <bool enable = false, typename F, typename... Arg>
void trace_call(const std::string &name, F &f, Arg &... args)
{
    if (enable) {
        default_tracer_t _(name, default_simple_ctx, default_log_ctx);
        f(args...);
    } else {
        f(args...);
    }
}

template <typename... Args> void logf(const Args &... args)
{
    default_log_ctx.logf(args...);
}

#endif
